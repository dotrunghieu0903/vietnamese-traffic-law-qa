<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tra C·ª©u Vi Ph·∫°m Lu·∫≠t Giao Th√¥ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    /* Thi·∫øt l·∫≠p font, m√†u n·ªÅn, m√†u ch·ªØ m·∫∑c ƒë·ªãnh cho body */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f3f3f3;
      color: #222;
      line-height: 1.5;
      font-size: 15;
      transition: background 0.2s ease, color 0.2s ease;
    }
    a { text-decoration: none; color: inherit; }
    ul { list-style: none; }

    /* Bi·∫øn CSS ‚Äì theme m·∫∑c ƒë·ªãnh (light) */
    :root {
      --primary: #f7941d;
      --primary-dark: #e1571a;
      --accent: #d52027;
      --border: #ddd;
      --bg-card: #ffffff;
      --bg-body: #f3f3f3;
      --text-main: #222;
      --text-muted: #666;
      --score-bar: #1e90ff;
    }

    /* Khi body c√≥ class .dark-mode ‚Üí override bi·∫øn m√†u */
    body.dark-mode {
      --bg-body: #111827;
      --bg-card: #1f2933;
      --border: #374151;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --primary: #f59e0b;
      --primary-dark: #ea580c;
      --accent: #f97316;
      --score-bar: #3b82f6;
      background: var(--bg-body);
      color: var(--text-main);
    }

    /* Wrapper ch√≠nh, gi·ªõi h·∫°n max-width v√† canh gi·ªØa */
    .container {
      width: 100%;       
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 0px;
    }

    /* TOPBAR (thanh tr√™n c√πng) */
    .topbar {
      background: linear-gradient(90deg, var(--primary-dark), var(--primary));
      color: #fff;
      font-size: 13px;
      padding: 6px 0;
    }
    body.dark-mode .topbar {
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    .topbar-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .topbar-left span {
      margin-right: 20px;
      opacity: 0.9;
    }
    .topbar-right a {
      margin-left: 20px;
      font-weight: 500;
    }

    /* HEADER (logo + n√∫t dark mode + m√¥ t·∫£) */
    .header {
      background: #fff;
      border-bottom: 2px solid var(--primary);
      padding: 10px 0;
    }
    body.dark-mode .header {
      background: #111827;
      border-bottom-color: #374151;
    }
    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .logo-area {
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .logo-circle {
      width: 75px;
      height: 75px;
      border-radius: 50%;
      border: 4px solid var(--primary-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--primary-dark);
      font-size: 13px;
      text-align: center;
    }
    .logo-text h1 {
      font-size: 20px;
      text-transform: uppercase;
      color: var(--primary-dark);
    }
    body.dark-mode .logo-text h1 {
      color: #f9fafb;
    }
    .logo-text span {
      font-size: 15px;
      color: #555;
    }
    body.dark-mode .logo-text span {
      color: var(--text-muted);
    }
    .header-actions {
      font-size: 13px;
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    /* N√∫t b·∫≠t/t·∫Øt dark mode */
    .dark-toggle-btn {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f3f0f2;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease,
                  transform 0.08s ease, box-shadow 0.15s ease;
    }
    .dark-toggle-btn span {
      font-size: 14px;
    }
    .dark-toggle-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    body.dark-mode .dark-toggle-btn {
      background: #111827;
      color: #e5e7eb;
      border-color: #4b5563;
    }

    /* NAV ‚Äì thanh menu d∆∞·ªõi header */
    .nav {
      background: var(--primary);
      border-bottom: 4px solid var(--primary-dark);
    }
    body.dark-mode .nav {
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    .nav ul {
      display: flex;
      flex-wrap: wrap;
    }
    .nav li {
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      border-right: 1px solid rgba(255,255,255,0.3);
      cursor: pointer;
      white-space: nowrap;
    }
    .nav li:hover {
      background: rgba(0,0,0,0.06);
    }
    .nav li.active {
      background: #fff4e5;
      color: var(--primary-dark);
    }

    /* SEARCH BAR ‚Äì ph·∫ßn nh·∫≠p c√¢u h·ªèi */
    .search-bar {
      background: #fff;
      border-bottom: 1px solid var(--border);
      padding: 14px 0 10px;
    }
    body.dark-mode .search-bar {
      background: #111827;
      border-bottom-color: #374151;
    }
    .search-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .search-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-row input {
      flex: 1;
      min-width: 220px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 3px;
      font-size: 15px;
      background: #ffffff;
      color: var(--text-main);
    }
    body.dark-mode .search-row input {
      background: #111827;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    .search-row button {
      background: #ffdd00;
      border: 1px solid #f0c200;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      border-radius: 3px;
    }
    .search-row button:hover {
      filter: brightness(0.97);
    }
    .search-meta {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* LAYOUT 3 C·ªòT ‚Äì tr√°i / gi·ªØa / ph·∫£i */
    .layout {
      margin-top: 12px;
      margin-bottom: 12px;
    }
    .columns {
      display: grid;
      grid-template-columns:
        minmax(160px, 0.25fr)   /* 20% */
        minmax(0, 0.55fr)       /* 55‚Äì60% */
        minmax(130px, 0.20fr);  /* 20% */
      gap: 16px;
    }

    /* Card chung cho c√°c kh·ªëi giao di·ªán */
    .card {
      background: var(--bg-card);
      border-radius: 3px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 1px rgba(0,0,0,0.04);
      padding: 10px;
      transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }
    body.dark-mode .card {
      box-shadow: 0 1px 3px rgba(0,0,0,0.35);
    }

    /* Header trong m·ªói card */
    .card-header {
      border-bottom: 1px solid var(--border);
      padding: 10px 14px;  
      margin: -10px -10px 12px -10px;  
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-card);
      border-radius: 3px 3px 0 0; 
  }
    body.dark-mode .card-header {
      border-bottom-color: #374151;
    }
    .card-header h2 {
      font-size: 14px;
      text-transform: uppercase;
      color: var(--primary-dark);
    }
    .badge-hot {
      background: var(--accent);
      color: #fff;
      padding: 1px 6px;
      font-size: 11px;
      border-radius: 3px;
      text-transform: uppercase;
    }

    /* SIDEBAR ‚Äì SVG + ANIMATION */
    .sidebar-menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 8px;
      border-radius: 10px;
      border: 1px solid transparent;
      cursor: pointer;
      transition:
        background 0.18s ease,
        border-color 0.18s ease,
        transform 0.12s ease,
        box-shadow 0.18s ease;
      font-size: 13px;
      background: var(--bg-card);
      color: var(--text-main);
    }

    .sidebar-item:hover {
      background: #fff7ec;
      border-color: #ffe0b5;
      transform: translateX(2px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.04);
    }
    body.dark-mode .sidebar-item:hover {
      background: #111827;
      border-color: #4b5563;
      box-shadow: 0 3px 6px rgba(0,0,0,0.4);
    }

    .sidebar-item.active {
      background: #fff3d4;
      border-color: #f7941d;
      box-shadow: 0 3px 8px rgba(247,148,29,0.18);
    }
    body.dark-mode .sidebar-item.active {
      background: #111827;
      border-color: #f59e0b;
      box-shadow: 0 3px 10px rgba(245,158,11,0.35);
    }

    .sidebar-icon-wrapper {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f97316, #fb923c);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: #fff;
      transition:
        transform 0.15s ease,
        box-shadow 0.18s ease,
        background 0.18s ease;
    }

    .sidebar-item:hover .sidebar-icon-wrapper,
    .sidebar-item.active .sidebar-icon-wrapper {
      transform: scale(1.05) rotate(-2deg);
      box-shadow: 0 3px 6px rgba(249,115,22,0.35);
      background: linear-gradient(135deg, #fb923c, #f97316);
    }

    .sidebar-icon-wrapper svg {
      width: 16px;
      height: 16px;
    }

    .sidebar-number {
      font-weight: 700;
      color: #f97316;
      min-width: 18px;
      text-align: right;
    }

    .sidebar-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
      text-align: left;
    }

    .sidebar-label {
      font-weight: 600;
    }

    .sidebar-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* K·∫æT QU·∫¢ ‚Äì text meta, danh s√°ch, v.v. */
    .answer-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .highlight {
      color: var(--primary-dark);
      font-weight: 600;
    }
    body.dark-mode .highlight {
      color: #fbbf24;
    }
    .result-list {
      margin-top: 4px;
    }
    .result-item {
      padding: 8px 4px;
      border-bottom: 1px solid #f3f3f3;
      font-size: 13px;
    }
    body.dark-mode .result-item {
      border-bottom-color: #374151;
    }
    .result-item:last-child {
      border-bottom: none;
    }
    .result-title {
      font-weight: 600;
      color: #d17015;
      margin-bottom: 2px;
    }
    body.dark-mode .result-title {
      color: #d17015;
    }
    .result-law {
      font-size: 12px;
      color: #555;
      margin-top: 2px;
    }
    body.dark-mode .result-law {
      color: #af6d41;
    }
    .result-penalty {
      font-size: 12px;
      color: #333;
      margin-top: 2px;
    }
    body.dark-mode .result-penalty {
      color: #e5e7eb;
    }
    .result-extra {
      font-size: 12px;
      color: #aa0000;
      margin-top: 2px;
    }
    body.dark-mode .result-extra {
      color: #fca5a5;
    }
    .no-result {
      font-style: italic;
      color: #888;
      padding: 4px 0;
    }
    body.dark-mode .no-result {
      color: #9ca3af;
    }

    /* SCORE / RANKING UI */
    .score-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }
    .score-bar {
      flex: 1;
      height: 6px;
      border-radius: 4px;
      background: #eee;
      overflow: hidden;
    }
    body.dark-mode .score-bar {
      background: #111827;
    }
    .score-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: var(--score-bar);       /* xanh bi·ªÉn */
      transition: width 0.25s ease-out;
    }
    .score-text {
      font-size: 12px;
      color: #555;
      white-space: nowrap;
    }
    body.dark-mode .score-text {
      color: #e5e7eb;
    }

     /* Filter lo·∫°i ph∆∞∆°ng ti·ªán (dropdown) */
    .filter-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .filter-row label {
      font-weight: 500;
    }
    .filter-select {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text-main);
    }
    body.dark-mode .filter-select {
      background: #111827;
      border-color: #4b5563;
      color: #e5e7eb;
    }

    /* C·ªòT PH·∫¢I ‚Äì banner info, l·ªãch s·ª≠, ... */
    .info-banner {
      font-size: 13px;
      padding: 8px;
      background: #fff7eb;
      border-radius: 3px;
      border: 1px dashed #f1b770;
    }
    body.dark-mode .info-banner {
      background: #111827;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    .info-banner strong {
      color: var(--primary-dark);
    }
    .history-item {
      padding: 6px 0;
      border-bottom: 1px solid #f3f3f3;
      cursor: pointer;
      font-size: 12px;
    }
    body.dark-mode .history-item {
      border-bottom-color: #374151;
    }
    .history-item:hover {
      background: #fff8ec;
    }
    body.dark-mode .history-item:hover {
      background: #111827;
    }

    /* FOOTER */
    .footer {
      background: #fff;
      border-top: 1px solid var(--border);
      font-size: 15px;
      color: #666;
      padding: 12px 0 18px;
    }
    body.dark-mode .footer {
      background: #111827;
      border-top-color: #374151;
      color: #9ca3af;
    }

    /* TAB CONTENT */
    .tab-content {
      display: block;
    }
    .tab-content.active {
      display: block;
    }

    /* STATISTICS DASHBOARD */
    .stat-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stat-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    body.dark-mode .stat-box:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .stat-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 4px;
    }
    body.dark-mode .stat-value {
      color: var(--primary);
    }
    .stat-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 4px;
    }
    .stat-help {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
    }

    .capability-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }
    .capability-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }
    .capability-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-main);
    }

    /* Refresh button */
    .refresh-btn {
      background: transparent;
      border: none;
      font-size: 14px;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .refresh-btn:hover {
      background: rgba(0,0,0,0.05);
      transform: rotate(90deg);
    }
    body.dark-mode .refresh-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    .refresh-btn:active {
      transform: rotate(180deg);
    }

    /* MINI STATS in Sidebar */
    .mini-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 4px;
    }
    .mini-stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--bg-body);
      border-radius: 6px;
      border: 1px solid var(--border);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .mini-stat-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    body.dark-mode .mini-stat-item:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .mini-stat-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    .mini-stat-content {
      flex: 1;
      min-width: 0;
    }
    .mini-stat-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-dark);
      line-height: 1.2;
    }
    body.dark-mode .mini-stat-value {
      color: var(--primary);
    }
    .mini-stat-label {
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* 
    M√†n h√¨nh l·ªõn (PC 1920px)
    M√†n h√¨nh trung b√¨nh (Laptop 1366px)
    M√°y t√≠nh b·∫£ng (~768px)
    ƒêi·ªán tho·∫°i (375px‚Äì414px)

    => N·∫øu kh√¥ng responsive, giao di·ªán s·∫Ω b·ªã: v·ª° b·ªë c·ª•c, tr√†n ch·ªØ, n√∫t b·∫•m nh·ªè, layout 3 c·ªôt k th·ªÉ hi·ªÉn th·ªã tr√™n ƒëi·ªán tho·∫°i
    */

    /* Responsive d∆∞·ªõi 960px: chuy·ªÉn layout 3 c·ªôt ‚Üí 1 c·ªôt */
    @media (max-width: 960px) {
      .columns {
        grid-template-columns: 1fr;
      }
    }
    /* Responsive d∆∞·ªõi 720px: ƒëi·ªÅu ch·ªânh header, nav, search button, ... */
    @media (max-width: 720px) {
      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }
      .nav ul {
        overflow-x: auto;
      }
      .search-row {
        flex-direction: column;
      }
      .search-row button {
        width: 100%;
      }
      .header-actions {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-inner container">
      <div class="topbar-left">
        <span>H·ªá th·ªëng tra c·ª©u vi ph·∫°m Lu·∫≠t giao th√¥ng Vi·ªát Nam</span>
      </div>
      <div class="topbar-right">
        <span>H·ªó tr·ª£: 1900 8099</span>
        <a href="#">H∆∞·ªõng d·∫´n</a>
        <a href="#">G√≥p √Ω</a>
      </div>
    </div>
  </div>

  <!-- HEADER: logo + m√¥ t·∫£ + dark mode toggle -->
  <header class="header">
    <div class="header-inner container">
      <div class="logo-area">
        <div class="logo-circle">
          TRAFFIC<br/>LAW
        </div>
        <div class="logo-text">
          <h1>Th∆∞ Vi·ªán Lu·∫≠t Giao Th√¥ng</h1>
          <span>Tra c·ª©u l·ªói, m·ª©c ph·∫°t v√† cƒÉn c·ª© ph√°p l√Ω theo Ngh·ªã ƒë·ªãnh 100/2019.</span>
        </div>
      </div>
      <div class="header-actions">
        <!-- <div>Phi√™n b·∫£n demo d√πng backend <strong>vietnamese-traffic-law-qa</strong></div> -->
        <!-- N√∫t b·∫≠t/t·∫Øt dark mode -->
        <button id="dark-toggle" class="dark-toggle-btn" type="button">
          <span id="dark-toggle-icon">üåô</span>
          <span id="dark-toggle-text">B·∫≠t dark mode</span>
        </button>
      </div>
    </div>
  </header>

  <!-- NAV -->
  <nav class="nav">
    <div class="container">
      <ul>
        <li class="nav-tab active" data-tab="search">Tra c·ª©u vi ph·∫°m</li>
        <li class="nav-tab" data-tab="fine">Tra c·ª©u m·ª©c ph·∫°t</li>
        <li class="nav-tab" data-tab="law">VƒÉn b·∫£n ph√°p lu·∫≠t</li>
        <li class="nav-tab" data-tab="stats">Th·ªëng k√™</li>
      </ul>
    </div>
  </nav>

  <!-- SEARCH BAR -->
  <section class="search-bar">
    <div class="container">
      <form class="search-form" onsubmit="return false;">
        <div class="search-row">
          <input
            id="query-input"
            type="text"
            placeholder="Nh·∫≠p h√†nh vi vi ph·∫°m ho·∫∑c c√¢u h·ªèi. V√≠ d·ª•: 'Ch·∫°y qu√° t·ªëc ƒë·ªô 15km/h trong khu d√¢n c∆∞ b·ªã ph·∫°t bao nhi√™u?'"
          />
          <button id="search-btn" type="button">T√¨m ki·∫øm</button>
        </div>
        <div class="search-meta">
          G·ª£i √Ω: m√¥ t·∫£ h√†nh vi c√†ng c·ª• th·ªÉ (lo·∫°i xe, ƒë·ªãa ƒëi·ªÉm, m·ª©c vi ph·∫°m) th√¨ k·∫øt qu·∫£ c√†ng ch√≠nh x√°c.
        </div>
      </form>
    </div>
  </section>

  <!-- MAIN LAYOUT -->
  <main class="layout">
    <!-- TAB: Tra c·ª©u vi ph·∫°m -->
    <div id="tab-search" class="tab-content active">
    <div class="container columns">
      <!-- C·ªòT TR√ÅI: SIDEBAR -->
      <aside class="card">
        <div class="card-header">
          <h2>Nh√≥m l·ªói ph·ªï bi·∫øn</h2>
        </div>

        <div class="sidebar-menu">
          <!-- 1. T·ªëc ƒë·ªô / L√†n ƒë∆∞·ªùng -->
          <button class="sidebar-item" type="button"
                  data-query="ch·∫°y qu√° t·ªëc ƒë·ªô trong khu d√¢n c∆∞ th√¨ b·ªã ph·∫°t g√¨?">
            <span class="sidebar-number">1.</span>
            <div class="sidebar-icon-wrapper">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="3" y="11" width="14" height="6" rx="2"
                      fill="none" stroke="currentColor" stroke-width="1.6"/>
                <circle cx="7" cy="18" r="2"
                        fill="none" stroke="currentColor" stroke-width="1.6"/>
                <circle cx="15" cy="18" r="2"
                        fill="none" stroke="currentColor" stroke-width="1.6"/>
                <line x1="2" y1="6" x2="22" y2="6"
                      stroke="currentColor" stroke-width="1.4"
                      stroke-linecap="round" />
                <line x1="8" y1="6" x2="12" y2="6"
                      stroke="#ffffff" stroke-width="1.4"
                      stroke-linecap="round" />
              </svg>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-label">T·ªëc ƒë·ªô / L√†n ƒë∆∞·ªùng</div>
              <div class="sidebar-sub">Ch·∫°y qu√° t·ªëc ƒë·ªô, ƒëi sai l√†n, v√†o ƒë∆∞·ªùng c·∫•m‚Ä¶</div>
            </div>
          </button>

          <!-- 2. N·ªìng ƒë·ªô c·ªìn / Ma t√∫y -->
          <button class="sidebar-item" type="button"
                  data-query="u·ªëng r∆∞·ª£u, bia khi l√°i xe m√°y th√¨ b·ªã ph·∫°t g√¨?">
            <span class="sidebar-number">2.</span>
            <div class="sidebar-icon-wrapper">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7 3h10v5a5 5 0 0 1-5 5 5 5 0 0 1-5-5V3z"
                      fill="none" stroke="currentColor" stroke-width="1.6"
                      stroke-linejoin="round"/>
                <line x1="12" y1="13" x2="12" y2="19"
                      stroke="currentColor" stroke-width="1.6"
                      stroke-linecap="round" />
                <line x1="9" y1="19" x2="15" y2="19"
                      stroke="currentColor" stroke-width="1.6"
                      stroke-linecap="round" />
                <path d="M8 5h8" stroke="#ffffff" stroke-width="1.2"
                      stroke-linecap="round" />
              </svg>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-label">N·ªìng ƒë·ªô c·ªìn / Ma t√∫y</div>
              <div class="sidebar-sub">U·ªëng r∆∞·ª£u bia, ch·∫•t k√≠ch th√≠ch khi ƒëi·ªÅu khi·ªÉn xe.</div>
            </div>
          </button>

          <!-- 3. D·ª´ng / ƒê·ªó xe -->
          <button class="sidebar-item" type="button"
                  data-query="d·ª´ng ƒë·ªó xe sai quy ƒë·ªãnh tr√™n ph·ªë th√¨ b·ªã ph·∫°t g√¨?">
            <span class="sidebar-number">3.</span>
            <div class="sidebar-icon-wrapper">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="4" y="3" width="16" height="18" rx="2"
                      fill="none" stroke="currentColor" stroke-width="1.6"/>
                <path d="M10 16V8h3a3 3 0 0 1 0 6h-3"
                      fill="none" stroke="currentColor" stroke-width="1.6"
                      stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-label">D·ª´ng ƒë·ªó / ƒê·ªó xe</div>
              <div class="sidebar-sub">D·ª´ng, ƒë·ªó sai n∆°i quy ƒë·ªãnh, g√¢y c·∫£n tr·ªü giao th√¥ng.</div>
            </div>
          </button>

          <!-- 4. Gi·∫•y t·ªù / GPLX -->
          <button class="sidebar-item" type="button"
                  data-query="kh√¥ng mang theo gi·∫•y t·ªù xe v√† gi·∫•y ph√©p l√°i xe th√¨ b·ªã ph·∫°t g√¨?">
            <span class="sidebar-number">4.</span>
            <div class="sidebar-icon-wrapper">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="5" y="4" width="12" height="16" rx="1.8"
                      fill="none" stroke="currentColor" stroke-width="1.6"/>
                <line x1="8" y1="9" x2="14" y2="9"
                      stroke="currentColor" stroke-width="1.4"
                      stroke-linecap="round"/>
                <line x1="8" y1="12" x2="14" y2="12"
                      stroke="currentColor" stroke-width="1.4"
                      stroke-linecap="round"/>
                <line x1="8" y1="15" x2="12" y2="15"
                      stroke="currentColor" stroke-width="1.4"
                      stroke-linecap="round"/>
              </svg>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-label">Gi·∫•y t·ªù / Gi·∫•y ph√©p l√°i xe</div>
              <div class="sidebar-sub">Thi·∫øu gi·∫•y t·ªù, kh√¥ng c√≥ ho·∫∑c kh√¥ng mang GPLX.</div>
            </div>
          </button>

          <!-- 5. M≈© b·∫£o hi·ªÉm -->
          <button class="sidebar-item" type="button"
                  data-query="kh√¥ng ƒë·ªôi m≈© b·∫£o hi·ªÉm khi ƒëi xe m√°y th√¨ b·ªã ph·∫°t g√¨?">
            <span class="sidebar-number">5.</span>
            <div class="sidebar-icon-wrapper">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 13a8 8 0 0 1 16 0v1H4z"
                      fill="none" stroke="currentColor" stroke-width="1.6"
                      stroke-linejoin="round" />
                <path d="M18 12h3"
                      stroke="currentColor" stroke-width="1.6"
                      stroke-linecap="round" />
                <path d="M9 14v2a2 2 0 0 0 2 2"
                      fill="none" stroke="currentColor" stroke-width="1.6"
                      stroke-linecap="round" />
              </svg>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-label">Kh√¥ng ƒë·ªôi m≈© b·∫£o hi·ªÉm</div>
              <div class="sidebar-sub">Kh√¥ng ƒë·ªôi ho·∫∑c ƒë·ªôi sai quy c√°ch khi ƒëi m√¥ t√¥, xe m√°y.</div>
            </div>
          </button>

          <!-- 6. Ch·ªü qu√° ng∆∞·ªùi / h√†ng -->
          <button class="sidebar-item" type="button"
                  data-query="ch·ªü qu√° s·ªë ng∆∞·ªùi quy ƒë·ªãnh tr√™n xe m√°y th√¨ b·ªã ph·∫°t g√¨?">
            <span class="sidebar-number">6.</span>
            <div class="sidebar-icon-wrapper">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="8" cy="8" r="2.4"
                        fill="none" stroke="currentColor" stroke-width="1.6"/>
                <circle cx="15" cy="8" r="2.4"
                        fill="none" stroke="currentColor" stroke-width="1.6"/>
                <path d="M5.5 16a3.5 3.5 0 0 1 7 0v2H5.5z"
                      fill="none" stroke="currentColor" stroke-width="1.6"
                      stroke-linejoin="round"/>
                <path d="M12.5 16a3.5 3.5 0 0 1 7 0v2h-7z"
                      fill="none" stroke="currentColor" stroke-width="1.6"
                      stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-label">Ch·ªü ng∆∞·ªùi / ch·ªü h√†ng qu√° quy ƒë·ªãnh</div>
              <div class="sidebar-sub">Ch·ªü qu√° ng∆∞·ªùi, qu√° t·∫£i ho·∫∑c h√†ng c·ªìng k·ªÅnh.</div>
            </div>
          </button>

          <!-- 7. ƒê√®n ƒë·ªè / t√≠n hi·ªáu -->
          <button class="sidebar-item" type="button"
                  data-query="v∆∞·ª£t ƒë√®n ƒë·ªè khi tham gia giao th√¥ng th√¨ b·ªã ph·∫°t g√¨?">
            <span class="sidebar-number">7.</span>
            <div class="sidebar-icon-wrapper">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="9" y="3" width="6" height="14" rx="2"
                      fill="none" stroke="currentColor" stroke-width="1.6"/>
                <circle cx="12" cy="7" r="1.6"
                        fill="none" stroke="currentColor" stroke-width="1.4"/>
                <circle cx="12" cy="11" r="1.6"
                        fill="none" stroke="currentColor" stroke-width="1.4"/>
                <circle cx="12" cy="15" r="1.6"
                        fill="none" stroke="currentColor" stroke-width="1.4"/>
                <line x1="12" y1="17" x2="12" y2="20"
                      stroke="currentColor" stroke-width="1.6"
                      stroke-linecap="round"/>
                <line x1="9" y1="20" x2="15" y2="20"
                      stroke="currentColor" stroke-width="1.6"
                      stroke-linecap="round"/>
              </svg>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-label">V∆∞·ª£t ƒë√®n ƒë·ªè / T√≠n hi·ªáu giao th√¥ng</div>
              <div class="sidebar-sub">Kh√¥ng ch·∫•p h√†nh t√≠n hi·ªáu ƒë√®n, bi·ªÉn b√°o, v·∫°ch k·∫ª ƒë∆∞·ªùng.</div>
            </div>
          </button>

          <!-- 8. L·ªói kh√°c -->
          <button class="sidebar-item" type="button"
                  data-query="bu√¥n b√°n tr√™n v·ªâa h√® th√¨ b·ªã ph·∫°t g√¨?">
            <span class="sidebar-number">8.</span>
            <div class="sidebar-icon-wrapper">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 19h16L12 4z"
                      fill="none" stroke="currentColor" stroke-width="1.6"
                      stroke-linejoin="round"/>
                <line x1="12" y1="10" x2="12" y2="14"
                      stroke="currentColor" stroke-width="1.6"
                      stroke-linecap="round"/>
                <circle cx="12" cy="17" r="1"
                        fill="currentColor"/>
              </svg>
            </div>
            <div class="sidebar-content">
              <div class="sidebar-label">C√°c l·ªói kh√°c</div>
              <div class="sidebar-sub">C√°c h√†nh vi vi ph·∫°m kh√°c trong Lu·∫≠t giao th√¥ng.</div>
            </div>
          </button>
        </div>
      </aside>

      <!-- C·ªòT GI·ªÆA: K·∫æT QU·∫¢ -->
      <section class="card">
        <div class="card-header">
          <h2>K·∫øt qu·∫£ tra c·ª©u</h2>
          <span class="badge-hot" id="status-label">S·∫µn s√†ng</span>
        </div>

        <!-- Filter lo·∫°i xe -->
        <div class="filter-row">
          <label for="vehicle-filter">L·ªçc theo lo·∫°i xe:</label>
          <select id="vehicle-filter" class="filter-select">
            <option value="all">T·∫•t c·∫£ ph∆∞∆°ng ti·ªán</option>
          </select>
        </div>

        <div class="answer-meta" id="meta-line">
          Ch∆∞a c√≥ truy v·∫•n n√†o.
        </div>

        <div class="answer-meta" id="intent-line" style="margin-bottom:8px;"></div>

        <div class="result-list" id="result-list">
          <div class="no-result">
            H√£y nh·∫≠p m√¥ t·∫£ h√†nh vi vi ph·∫°m ·ªü tr√™n v√† b·∫•m "T√¨m ki·∫øm".
          </div>
        </div>
      </section>

      <!-- C·ªòT PH·∫¢I: TH·ªêNG K√ä / L·ªäCH S·ª¨ / L∆ØU √ù -->
      <aside>
        <!-- Th·ªëng k√™ h·ªá th·ªëng -->
        <div class="card" style="margin-bottom: 10px;">
          <div class="card-header">
            <h2>üìä Th·ªëng k√™ h·ªá th·ªëng</h2>
            <button id="refresh-stats-btn" class="refresh-btn" type="button" title="L√†m m·ªõi th·ªëng k√™">üîÑ</button>
          </div>
          <div class="mini-stats">
            <div class="mini-stat-item">
              <span class="mini-stat-icon">üìù</span>
              <div class="mini-stat-content">
                <div class="mini-stat-value" id="mini-stat-violations">-</div>
                <div class="mini-stat-label">Vi ph·∫°m</div>
              </div>
            </div>
            <div class="mini-stat-item">
              <span class="mini-stat-icon">üß†</span>
              <div class="mini-stat-content">
                <div class="mini-stat-value" id="mini-stat-nodes">-</div>
                <div class="mini-stat-label">Nodes</div>
              </div>
            </div>
            <div class="mini-stat-item">
              <span class="mini-stat-icon">üîó</span>
              <div class="mini-stat-content">
                <div class="mini-stat-value" id="mini-stat-relations">-</div>
                <div class="mini-stat-label">Relations</div>
              </div>
            </div>
            <div class="mini-stat-item">
              <span class="mini-stat-icon">üìä</span>
              <div class="mini-stat-content">
                <div class="mini-stat-value" id="mini-stat-density">-</div>
                <div class="mini-stat-label">Density</div>
              </div>
            </div>
          </div>
        </div>

        <!-- L·ªãch s·ª≠ tra c·ª©u -->
        <div class="card">
          <div class="card-header">
            <h2>L·ªãch s·ª≠ tra c·ª©u</h2>
          </div>
          <div id="history-list">
            <!-- render b·∫±ng JS -->
          </div>
        </div>

        <div class="card info-banner" style="margin-top:10px;">
          <strong>L∆∞u √Ω:</strong><br/>
          K·∫øt qu·∫£ ƒë∆∞·ª£c tr√≠ch xu·∫•t t·ª± ƒë·ªông t·ª´ ƒë·ªì th·ªã Neo4j Ngh·ªã ƒë·ªãnh 100/2019/Nƒê-CP.
          Trong tr∆∞·ªùng h·ª£p c√≥ nhi·ªÅu ƒëi·ªÅu lu·∫≠t li√™n quan, b·∫°n n√™n ƒë·ªçc k·ªπ n·ªôi dung
          ƒëi·ªÅu kho·∫£n tr∆∞·ªõc khi √°p d·ª•ng.
        </div>
      </aside>
    </div>
    </div>
    <!-- End tab-search -->

    <!-- TAB: Th·ªëng k√™ h·ªá th·ªëng -->
    <div id="tab-stats" class="tab-content" style="display: none;">
      <div class="container">
        <h2 style="color: var(--primary-dark); margin-bottom: 20px;">üìä Dashboard H·ªá th·ªëng</h2>
        
        <!-- System Overview -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-header">
            <h2>üèóÔ∏è T·ªïng quan h·ªá th·ªëng</h2>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; padding: 10px;">
            <div class="stat-box">
              <div class="stat-icon">üìù</div>
              <div class="stat-value" id="stat-violations">-</div>
              <div class="stat-label">T·ªïng Vi ph·∫°m</div>
              <div class="stat-help">S·ªë l∆∞·ª£ng h√†nh vi vi ph·∫°m trong c∆° s·ªü d·ªØ li·ªáu</div>
            </div>
            
            <div class="stat-box">
              <div class="stat-icon">üß†</div>
              <div class="stat-value" id="stat-nodes">-</div>
              <div class="stat-label">Knowledge Nodes</div>
              <div class="stat-help">T·ªïng s·ªë nodes trong knowledge graph</div>
            </div>
            
            <div class="stat-box">
              <div class="stat-icon">üîó</div>
              <div class="stat-value" id="stat-relations">-</div>
              <div class="stat-label">Relations</div>
              <div class="stat-help">T·ªïng s·ªë m·ªëi quan h·ªá gi·ªØa c√°c nodes</div>
            </div>
            
            <div class="stat-box">
              <div class="stat-icon">üìä</div>
              <div class="stat-value" id="stat-density">-</div>
              <div class="stat-label">Graph Density</div>
              <div class="stat-help">M·∫≠t ƒë·ªô k·∫øt n·ªëi c·ªßa knowledge graph (0-1)</div>
            </div>
          </div>
        </div>

        <!-- Capabilities -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-header">
            <h2>üöÄ Kh·∫£ nƒÉng h·ªá th·ªëng</h2>
          </div>
          
          <div id="capabilities-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; padding: 10px;">
            <!-- Capabilities will be rendered here by JavaScript -->
          </div>
        </div>
      </div>
    </div>
    <!-- End tab-stats -->

    <!-- TAB: Tra c·ª©u m·ª©c ph·∫°t (placeholder) -->
    <div id="tab-fine" class="tab-content" style="display: none;">
      <div class="container">
        <div class="card">
          <div class="card-header">
            <h2>Tra c·ª©u m·ª©c ph·∫°t</h2>
          </div>
          <div style="padding: 20px; text-align: center; color: var(--text-muted);">
            <p>T√≠nh nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: VƒÉn b·∫£n ph√°p lu·∫≠t (placeholder) -->
    <div id="tab-law" class="tab-content" style="display: none;">
      <div class="container">
        <div class="card">
          <div class="card-header">
            <h2>VƒÉn b·∫£n ph√°p lu·∫≠t</h2>
          </div>
          <div style="padding: 20px; text-align: center; color: var(--text-muted);">
            <p>T√≠nh nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn...</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container">
      ¬© 2025 H·ªá th·ªëng Tra C·ª©u Vi Ph·∫°m Giao Th√¥ng.
ƒê·ªì √°n m√¥n h·ªçc ‚ÄúM√¥ h√¨nh tri th·ª©c quan h·ªá v√† ·ª©ng d·ª•ng‚Äù ‚Äì Nh√≥m 10 ‚Äì GVHD: PGS.TS. Nguy·ªÖn ƒê√¨nh Hi·ªÉn.
    </div>
  </footer>

  <script>
    // ============================================
    // Auto-detect API URL based on environment
    // ============================================
    function getApiUrl() {
      const hostname = window.location.hostname;
      
      // Local development
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://localhost:8000';
      }
      
      // Ngrok deployment
      if (hostname.includes('ngrok-free.app') || hostname.includes('ngrok.io')) {
        // TODO: Update this URL after deploying with ngrok
        // Run: ngrok http 8000
        // Then copy the URL here (e.g., 'https://abc123.ngrok-free.app')
        const ngrokBackendUrl = 'https://YOUR_BACKEND_URL.ngrok-free.app';
        if (ngrokBackendUrl.includes('YOUR_BACKEND_URL')) {
          console.warn('‚ö†Ô∏è NGROK: Please update the backend URL in index.html!');
          // Fallback to localhost
          return 'http://localhost:8000';
        }
        return ngrokBackendUrl;
      }
      
      // Railway deployment
      if (hostname.includes('railway.app')) {
        // TODO: Update this URL after deploying to Railway
        const railwayBackendUrl = 'https://traffic-law-api-production.up.railway.app';
        if (railwayBackendUrl.includes('traffic-law-api-production')) {
          console.warn('‚ö†Ô∏è RAILWAY: Please update the backend URL in index.html!');
        }
        return railwayBackendUrl;
      }
      
      // Render deployment
      if (hostname.includes('onrender.com')) {
        // TODO: Update this URL after deploying to Render
        const renderBackendUrl = 'https://traffic-law-api.onrender.com';
        if (renderBackendUrl.includes('traffic-law-api.onrender')) {
          console.warn('‚ö†Ô∏è RENDER: Please update the backend URL in index.html!');
        }
        return renderBackendUrl;
      }
      
      // Vercel or other platforms
      if (hostname.includes('vercel.app')) {
        // TODO: Update this URL to point to your backend
        const vercelBackendUrl = 'https://YOUR_BACKEND_URL.up.railway.app';
        if (vercelBackendUrl.includes('YOUR_BACKEND_URL')) {
          console.warn('‚ö†Ô∏è VERCEL: Please update the backend URL in index.html!');
          // Fallback to localhost for testing
          return 'http://localhost:8000';
        }
        return vercelBackendUrl;
      }
      
      // Default fallback
      console.warn('‚ö†Ô∏è Unknown hosting environment. Using localhost.');
      return 'http://localhost:8000';
    }

    // Get API base URL and construct endpoint
    const API_BASE_URL = getApiUrl();
    const API_ENDPOINT = `${API_BASE_URL}/search`;
    const API_STATS_ENDPOINT = `${API_BASE_URL}/stats`;
    
    // Log for debugging
    console.log('üåê Hostname:', window.location.hostname);
    console.log('üîó API Base URL:', API_BASE_URL);
    console.log('üì° API Endpoint:', API_ENDPOINT);
    console.log('üìä Stats Endpoint:', API_STATS_ENDPOINT);

    const queryInput   = document.getElementById("query-input");
    const searchBtn    = document.getElementById("search-btn");
    const statusLabel  = document.getElementById("status-label");
    const metaLine     = document.getElementById("meta-line");
    const intentLine   = document.getElementById("intent-line");
    const resultList   = document.getElementById("result-list");
    const historyList  = document.getElementById("history-list");
    const vehicleFilter = document.getElementById("vehicle-filter");

    const darkToggleBtn   = document.getElementById("dark-toggle");
    const darkToggleIcon  = document.getElementById("dark-toggle-icon");
    const darkToggleText  = document.getElementById("dark-toggle-text");

    const historyData = [];

    // L∆∞u last query & data ƒë·ªÉ filter l·∫°i
    let lastQuery = "";
    let lastData = null;
    let currentFilter = "all";

    async function doSearch() {
      const q = queryInput.value.trim();
      if (!q) {
        alert("Vui l√≤ng nh·∫≠p m√¥ t·∫£ h√†nh vi vi ph·∫°m ho·∫∑c c√¢u h·ªèi.");
        return;
      }

      statusLabel.textContent = "ƒêang tra c·ª©u...";
      statusLabel.style.background = "#999";

      try {
        const res = await fetch(API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: q, top_k: 10 })
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        // C·∫≠p nh·∫≠t dropdown filter vehicle
        const data = await res.json();
        lastQuery = q;
        lastData  = data;
        currentFilter = "all";

        populateVehicleFilter(data);
        renderResults();
        pushHistory(q, data);

        statusLabel.textContent = "Ho√†n th√†nh";
        statusLabel.style.background = "#28a745";
      } catch (err) {
        console.error(err);
        statusLabel.textContent = "L·ªói";
        statusLabel.style.background = "#d52027";
        metaLine.textContent = "ƒê√£ x·∫£y ra l·ªói khi g·ªçi API backend. Vui l√≤ng ki·ªÉm tra l·∫°i api.py ho·∫∑c Neo4j.";
        intentLine.textContent = "";
        resultList.innerHTML = '<div class="no-result">Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ API.</div>';
      }
    }

    /**
     * H√†m render to√†n b·ªô k·∫øt qu·∫£ (d·ª±a tr√™n lastData + currentFilter)
    */

    function renderResults() {
      if (!lastData) {
        resultList.innerHTML = '<div class="no-result">Ch∆∞a c√≥ truy v·∫•n n√†o.</div>';
        return;
      }

      const data = lastData;
      let results = data.results || [];

      // √Åp d·ª•ng filter lo·∫°i xe
      if (currentFilter !== "all") {
        results = results.filter(r => (r.vehicle_category || "") === currentFilter);
      }

      const intent   = data.detected_intent;
      const category = data.detected_category;

      metaLine.innerHTML =
        'C√¢u h·ªèi: <span class="highlight">' + escapeHtml(lastQuery) + "</span>";

      let intentText = "";
      if (intent) {
        intentText += '√ù ƒë·ªãnh truy v·∫•n: <span class="highlight">' + escapeHtml(intent) + "</span>";
      }
      if (category) {
        if (intentText) intentText += " &nbsp;|&nbsp; ";
        intentText += 'Nh√≥m ƒë·ªëi t∆∞·ª£ng: <span class="highlight">' + escapeHtml(category) + "</span>";
      }
      if (currentFilter !== "all") {
        if (intentText) intentText += " &nbsp;|&nbsp; ";
        intentText += 'ƒêang l·ªçc theo lo·∫°i xe: <span class="highlight">' + escapeHtml(currentFilter) + "</span>";
      }
      intentLine.innerHTML = intentText;

      if (!results.length) {
        resultList.innerHTML =
          // '<div class="no-result">Kh√¥ng t√¨m th·∫•y ƒëi·ªÅu lu·∫≠t ph√π h·ª£p v·ªõi b·ªô l·ªçc hi·ªán t·∫°i. H√£y th·ª≠ b·ªè l·ªçc ho·∫∑c m√¥ t·∫£ chi ti·∫øt h∆°n.</div>';
          '<div class="no-result">Kh√¥ng t√¨m th·∫•y ƒëi·ªÅu lu·∫≠t ph√π h·ª£p v·ªõi c√¢u h·ªèi n√†y trong d·ªØ li·ªáu Ngh·ªã ƒë·ªãnh 100/2019/Nƒê-CP.</div>';
          '<div class="no-result">Kh√¥ng t√¨m th·∫•y ƒëi·ªÅu lu·∫≠t ph√π h·ª£p v·ªõi c√¢u h·ªèi n√†y trong d·ªØ li·ªáu.</div>';

        autoHighlightWithResult(data);
        return;
      }

      // T√¨m maxScore ƒë·ªÉ t√≠nh % ƒë·ªô li√™n quan n·∫øu backend kh√¥ng tr·∫£ s·∫µn relevance_percent
      let maxScore = 0;
      results.forEach(r => {
        if (typeof r.score === "number" && r.score > maxScore) {
          maxScore = r.score;
        }
      });

      resultList.innerHTML = "";
      results.forEach((r, idx) => {
        const div = document.createElement("div");
        div.className = "result-item";

        // --- Title v·ªõi th·ª© h·∫°ng ---
        const title = document.createElement("div");
        title.className = "result-title";
        title.innerHTML = "<strong>" + (idx + 1) + ".</strong> " +
          escapeHtml(r.description || "(Kh√¥ng c√≥ m√¥ t·∫£)");

        // --- T√≠nh % ƒë·ªô li√™n quan ---
        let relevancePercent = null;
        if (typeof r.relevance_percent === "number") {
          relevancePercent = r.relevance_percent;
        } else if (maxScore > 0 && typeof r.score === "number") {
          relevancePercent = +(r.score / maxScore * 100).toFixed(2);
        }

        // --- Score row: thanh % + text ---
        if (relevancePercent !== null) {
          const scoreRow = document.createElement("div");
          scoreRow.className = "score-row";

          const scoreBar = document.createElement("div");
          scoreBar.className = "score-bar";

          const fill = document.createElement("div");
          fill.className = "score-bar-fill";
          const width = Math.max(0, Math.min(relevancePercent, 100));
          fill.style.width = width + "%";

          scoreBar.appendChild(fill);

          const scoreText = document.createElement("div");
          scoreText.className = "score-text";
          scoreText.textContent = "ƒê·ªô li√™n quan: " + relevancePercent + "%";

          scoreRow.appendChild(scoreBar);
          scoreRow.appendChild(scoreText);

          div.appendChild(title);
          div.appendChild(scoreRow);
        } else {
          div.appendChild(title);
        }

        // --- Law info ---
        const law = document.createElement("div");
        law.className = "result-law";
        law.textContent =
          "CƒÉn c·ª©: " +
          (r.law_article || "") +
          (r.law_clause ? ", " + r.law_clause : "") +
          (r.vehicle_category ? " ‚Äì ƒê·ªëi t∆∞·ª£ng: " + r.vehicle_category : "");

        div.appendChild(law);

        // --- Fine ---
        if (r.fine_text) {
          const penalty = document.createElement("div");
          penalty.className = "result-penalty";
          penalty.textContent = "M·ª©c ph·∫°t: " + r.fine_text;
          div.appendChild(penalty);
        }

        // --- Extra penalties ---
        if (Array.isArray(r.extra_penalties) && r.extra_penalties.length) {
          const extra = document.createElement("div");
          extra.className = "result-extra";
          extra.textContent = "H√¨nh ph·∫°t b·ªï sung: " + r.extra_penalties.join("; ");
          div.appendChild(extra);
        }

        resultList.appendChild(div);
      });

      autoHighlightWithResult(data);
    }

    function populateVehicleFilter(data) {
      const results = data.results || [];
      const categories = new Set();
      results.forEach(r => {
        if (r.vehicle_category) {
          categories.add(r.vehicle_category);
        }
      });

      vehicleFilter.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "all";
      optAll.textContent = "T·∫•t c·∫£ ph∆∞∆°ng ti·ªán";
      vehicleFilter.appendChild(optAll);

      Array.from(categories).forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        vehicleFilter.appendChild(opt);
      });
    }

    function pushHistory(query, data) {
      historyData.unshift({
        query,
        time: new Date(),
        data
      });

      // N·∫øu qu√° 10 th√¨ b·ªè b·ªõt cu·ªëi
      if (historyData.length > 10) historyData.pop();

      // X√≥a danh s√°ch l·ªãch s·ª≠ c≈©
      // T·∫°o danh s√°ch l·ªãch s·ª≠ m·ªõi
      historyList.innerHTML = "";
      // Render l·∫°i danh s√°ch l·ªãch s·ª≠ m·ªõi
      historyData.forEach(item => {
        const div = document.createElement("div");
        div.className = "history-item";
        // Click l√™n item l·ªãch s·ª≠ ‚Üí hi·ªÉn th·ªã l·∫°i k·∫øt qu·∫£ ƒë√£ l∆∞u
        div.onclick = () => {
          lastQuery = item.query;
          lastData  = item.data;
          currentFilter = "all";
          populateVehicleFilter(item.data);
          renderResults();
        };

        const q = document.createElement("div");
        q.textContent = item.query;

        const t = document.createElement("div");
        t.style.fontSize = "11px";
        t.style.color = "#999";
        // Hi·ªÉn th·ªã th·ªùi gian l∆∞u l·ªãch s·ª≠ theo ƒë·ªãnh d·∫°ng "HH:MM:SS"
        t.textContent = item.time.toLocaleTimeString("vi-VN");

        div.appendChild(q);
        div.appendChild(t);
        historyList.appendChild(div);
      });
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // G·∫Øn s·ª± ki·ªán cho sidebar: click ‚Üí ƒëi·ªÅn query + g·ªçi t√¨m ki·∫øm
    function setupSidebar() {
      const sidebarItems = document.querySelectorAll(".sidebar-item");
      sidebarItems.forEach(item => {
        item.addEventListener("click", () => {
          sidebarItems.forEach(i => i.classList.remove("active"));
          item.classList.add("active");

          const q = item.dataset.query || "";
          queryInput.value = q;
          if (q) {
            doSearch();
          }
        });
      });
    }

    // Sidebar mapping d·ª±a tr√™n t·ª´ kh√≥a ƒë·ªÉ auto-highlight
    const SIDEBAR_KEYWORDS = [
      { index: 1, keywords: ["t·ªëc ƒë·ªô", "qu√° t·ªëc ƒë·ªô", "l√†n ƒë∆∞·ªùng", "ƒë∆∞·ªùng c·∫•m", "chuy·ªÉn l√†n"] },
      { index: 2, keywords: ["n·ªìng ƒë·ªô c·ªìn", "r∆∞·ª£u bia", "ma t√∫y"] },
      { index: 3, keywords: ["d·ª´ng ƒë·ªó", "d·ª´ng xe", "ƒë·ªó xe", "ch·∫Øn l·ªëi"] },
      { index: 4, keywords: ["gi·∫•y t·ªù", "gplx", "b·∫±ng l√°i", "ƒëƒÉng k√Ω xe"] },
      { index: 5, keywords: ["m≈© b·∫£o hi·ªÉm", "kh√¥ng ƒë·ªôi m≈©"] },
      { index: 6, keywords: ["ch·ªü ng∆∞·ªùi", "qu√° s·ªë ng∆∞·ªùi", "qu√° t·∫£i", "c·ªìng k·ªÅnh"] },
      { index: 7, keywords: ["ƒë√®n ƒë·ªè", "v∆∞·ª£t ƒë√®n", "t√≠n hi·ªáu giao th√¥ng"] },
      { index: 8, keywords: ["vi ph·∫°m", "giao th√¥ng"] } // fallback
    ];

    /**
     * T·ª± ƒë·ªông highlight item sidebar ph√π h·ª£p,
     * d·ª±a tr√™n intent, category ho·∫∑c description k·∫øt qu·∫£ ƒë·∫ßu ti√™n.
     */

    function autoHighlightWithResult(data) {
      const sidebarItems = document.querySelectorAll(".sidebar-item");
      sidebarItems.forEach(i => i.classList.remove("active"));

      let targetIndex = null;
      const intent = (data.detected_intent || "").toLowerCase();
      const category = (data.detected_category || "").toLowerCase();
      let firstDescription = "";
      if (data.results && data.results.length > 0) {
        firstDescription = (data.results[0].description || "").toLowerCase();
      }

      function tryMatch(sourceText) {
        if (!sourceText) return;
        SIDEBAR_KEYWORDS.forEach(group => {
          if (!targetIndex && group.keywords.some(kw => sourceText.includes(kw))) {
            targetIndex = group.index;
          }
        });
      }

      // ∆Øu ti√™n: intent ‚Üí category ‚Üí m√¥ t·∫£ l·ªói
      // 1. intent
      tryMatch(intent);
      // 2. category
      tryMatch(category);
      // 3. m√¥ t·∫£ l·ªói
      tryMatch(firstDescription);

      // N·∫øu kh√¥ng match ƒë∆∞·ª£c g√¨ th√¨ ch·ªçn item s·ªë 8 (c√°c l·ªói kh√°c)
      if (!targetIndex) targetIndex = 8;

      const targetItem = document.querySelector(`.sidebar-item:nth-child(${targetIndex})`);
      if (targetItem) {
        targetItem.classList.add("active");
      }
    }

    // Dark mode toggle + l∆∞u localStorage
    function applyThemeFromStorage() {
      const theme = localStorage.getItem("gtlaw_theme");
      if (theme === "dark") {
        document.body.classList.add("dark-mode");
        darkToggleIcon.textContent = "‚òÄÔ∏è";
        darkToggleText.textContent = "T·∫Øt dark mode";
      } else {
        document.body.classList.remove("dark-mode");
        darkToggleIcon.textContent = "üåô";
        darkToggleText.textContent = "B·∫≠t dark mode";
      }
    }

    darkToggleBtn.addEventListener("click", () => {
      const isDark = document.body.classList.toggle("dark-mode");
      localStorage.setItem("gtlaw_theme", isDark ? "dark" : "light");
      applyThemeFromStorage();
    });

    // Filter dropdown change
    vehicleFilter.addEventListener("change", () => {
      currentFilter = vehicleFilter.value;
      renderResults();
    });

    // event listeners
    searchBtn.addEventListener("click", doSearch);
    queryInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        doSearch();
      }
    });

    // ============================================
    // TAB NAVIGATION
    // ============================================
    function setupTabs() {
      const navTabs = document.querySelectorAll(".nav-tab");
      const tabContents = document.querySelectorAll(".tab-content");
      
      navTabs.forEach(tab => {
        tab.addEventListener("click", () => {
          const targetTab = tab.dataset.tab;
          
          // Update active nav tab
          navTabs.forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          
          // Show target tab content
          tabContents.forEach(content => {
            content.style.display = "none";
          });
          
          const targetContent = document.getElementById(`tab-${targetTab}`);
          if (targetContent) {
            targetContent.style.display = "block";
          }
          
          // Load stats if stats tab is selected (use cache if available)
          if (targetTab === "stats") {
            loadSystemStats(false); // false = use cache
          }
        });
      });
    }

    // ============================================
    // LOAD SYSTEM STATISTICS
    // ============================================
    let cachedStats = null; // Cache stats to avoid multiple API calls

    async function loadSystemStats(forceRefresh = false) {
      // Use cached stats if available and not forcing refresh
      if (cachedStats && !forceRefresh) {
        renderSystemStats(cachedStats);
        renderMiniStats(cachedStats);
        return;
      }

      try {
        const res = await fetch(API_STATS_ENDPOINT);
        
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        
        const stats = await res.json();
        cachedStats = stats; // Cache the results
        renderSystemStats(stats);
        renderMiniStats(stats);
      } catch (err) {
        console.error("Error loading stats:", err);
        showStatsError();
        showMiniStatsError();
      }
    }

    function renderSystemStats(stats) {
      const kg = stats.knowledge_graph || {};
      const info = stats.system_info || {};
      
      // System Overview
      // Support both 'behavior' and 'violation' labels
      document.getElementById("stat-violations").textContent = 
        kg.node_types?.behavior || kg.node_types?.violation || 
        kg.node_types?.Behavior || kg.node_types?.Violation || 0;
      document.getElementById("stat-nodes").textContent = 
        kg.total_nodes || 0;
      document.getElementById("stat-relations").textContent = 
        kg.total_relations || 0;
      document.getElementById("stat-density").textContent = 
        (kg.graph_density || 0).toFixed(3);
      
      // Capabilities
      renderCapabilities(info.capabilities || {});
    }

    function renderCapabilities(capabilities) {
      const container = document.getElementById("capabilities-container");
      container.innerHTML = "";
      
      for (const [name, enabled] of Object.entries(capabilities)) {
        const box = document.createElement("div");
        box.className = "capability-box";
        
        const icon = document.createElement("div");
        icon.className = "capability-icon";
        icon.textContent = enabled ? "‚úÖ" : "‚ùå";
        
        const label = document.createElement("div");
        label.className = "capability-name";
        label.textContent = name.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
        
        box.appendChild(icon);
        box.appendChild(label);
        container.appendChild(box);
      }
    }

    function renderMiniStats(stats) {
      const kg = stats.knowledge_graph || {};
      
      // Update mini stats in sidebar
      const violations = kg.node_types?.behavior || kg.node_types?.violation || 
                        kg.node_types?.Behavior || kg.node_types?.Violation || 0;
      const totalNodes = kg.total_nodes || 0;
      const totalRelations = kg.total_relations || 0;
      const density = (kg.graph_density || 0).toFixed(3);
      
      document.getElementById("mini-stat-violations").textContent = violations.toLocaleString();
      document.getElementById("mini-stat-nodes").textContent = totalNodes.toLocaleString();
      document.getElementById("mini-stat-relations").textContent = totalRelations.toLocaleString();
      document.getElementById("mini-stat-density").textContent = density;
    }

    function showStatsError() {
      document.getElementById("stat-violations").textContent = "Error";
      document.getElementById("stat-nodes").textContent = "Error";
      document.getElementById("stat-relations").textContent = "Error";
      document.getElementById("stat-density").textContent = "Error";
      
      const capContainer = document.getElementById("capabilities-container");
      capContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi API.</p>';
    }

    function showMiniStatsError() {
      document.getElementById("mini-stat-violations").textContent = "?";
      document.getElementById("mini-stat-nodes").textContent = "?";
      document.getElementById("mini-stat-relations").textContent = "?";
      document.getElementById("mini-stat-density").textContent = "?";
    }

    // Refresh stats button
    const refreshStatsBtn = document.getElementById("refresh-stats-btn");
    if (refreshStatsBtn) {
      refreshStatsBtn.addEventListener("click", () => {
        loadSystemStats(true); // true = force refresh (no cache)
      });
    }

    // init
    setupSidebar();
    setupTabs();
    applyThemeFromStorage();
    
    // Load mini stats on page load
    loadSystemStats();
  </script>
</body>
</html>

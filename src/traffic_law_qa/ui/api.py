# api.py
import os
import json
import sys
from pathlib import Path
from typing import Optional 

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel

# Lấy thư mục gốc của project
project_root = Path(__file__).parent.parent.parent.parent
sys.path.insert(0, str(project_root))

from system.model import Model
from scripts.category_detector import VehicleCategoryDetector
from system.utils import extract_entities_with_llm


# Import the Neo4j-based QA adapter
from system.qa_adapter import Neo4jQAAdapter


def remove_duplicates(input_list):
    """
    Loại bỏ trùng lặp và giữ nguyên thứ tự.
    """
    if not input_list:
        return []
    return list(dict.fromkeys(input_list))


# --------- KHỞI TẠO FastAPI App ----------
app = FastAPI(
    title="Vietnamese Traffic Law Search API",
    description="Hybrid (vector + BM25) search trên Neo4j cho luật giao thông",
    version="1.0.0",
)

# Cho phép gọi từ web tĩnh (Vercel/localhost/…)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],         
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --------- LOAD DETECTOR & MODEL ----------
detector = VehicleCategoryDetector()
vehicle_patterns = [k for k in detector.vehicle_patterns]
business_patterns = [k for k in detector.business_patterns]
fallback_patterns = [k for k in detector.fallback_categories]


# ---------  Neo4j database connection ----------
NEO4J_URI  = os.getenv("NEO4J_URI", "neo4j+s://7aa78485.databases.neo4j.io")
NEO4J_USER = os.getenv("NEO4J_USER", "neo4j")
NEO4J_PASS = os.getenv("NEO4J_PASS", "iX59KTgWRNyZvmkh3dDBGe0Dwbm-_XQGdP1KCW_m7rs")

model = Model(uri=NEO4J_URI, auth=(NEO4J_USER, NEO4J_PASS))


# API /search receive JSON include: question, top_k, verbose
class SearchRequest(BaseModel):
    question: str
    top_k: int = 10
    verbose: bool = False
    document_name: Optional[str]


@app.post("/search")
def search(req: SearchRequest):
    """
    Nhận câu hỏi tiếng Việt tự nhiên, trả về danh sách điều luật phù hợp.
    """
    # Dùng LLM để bóc tách intent & category (chỉ để trả về cho frontend)
    extraction = extract_entities_with_llm(
        req.question,
        vehicle_patterns,
        business_patterns,
        fallback_patterns,
    )
    target_category = extraction.get("category")
    query_intent = extraction.get("intent")

    # Gọi hybrid_search để lấy kết quả
    raw_results = model.hybrid_search(
        req.question,
        vehicle_patterns,
        business_patterns,
        fallback_patterns,
        top_k=req.top_k,
        verbose=req.verbose,
        decree_filter=req.document_name
    )
    

    if req.document_name == "ND168":
        with open("/mnt/mmlabworkspace/WorkSpaces/ngaptb/HumanActionMimic/vietnamese-traffic-law-qa-master/data/processed/article2category_ND168.json", "r") as f:
            article2category = json.load(f)
    elif req.document_name == "ND100":
        with open("/mnt/mmlabworkspace/WorkSpaces/ngaptb/HumanActionMimic/vietnamese-traffic-law-qa-master/data/processed/article2category_ND100.json", "r") as f:
            article2category = json.load(f)
    for result in raw_results:
        result['data']['category'] = article2category[result['data']['law_article']]
        if result['data']['document'] == "ND168":
            result['data']['document'] = "Nghị định 168/2024/NĐ-CP"
        elif result['data']['document'] == "ND100":
            result['data']['document'] = "Nghị định 100/2019/NĐ-CP"
        result['data']['extra'] = remove_duplicates(result['data']['extra'])
    print('raw_results: ', raw_results)


    # hybrid_search trả về list các phần tử:
    # { "data": item, "score": tổng RRF }
    # trong đó item có: id, text, category, fine_min, fine_max, law_article, law_clause, extra, vector_score/bm25_score
    results = []
    for r in raw_results:
        data = r["data"]
        score = float(r["score"])
        fine_min = data.get("fine_min")
        fine_max = data.get("fine_max")

        if fine_min is not None and fine_max is not None:
            fine_text = f"{fine_min:,} - {fine_max:,} VNĐ".replace(",", ".")
        elif fine_min is not None:
            fine_text = f"Tối thiểu {fine_min:,} VNĐ".replace(",", ".")
        else:
            fine_text = ""

        # Extract law_point from full_ref if available
        law_point = None
        full_ref = data.get("full_ref", "")
        if full_ref and "Điểm" in full_ref:
            # Extract "Điểm x" from full_ref (e.g., "Nghị định 168/2024/NĐ-CP, Điều 6, Khoản 5, Điểm p")
            parts = full_ref.split(", ")
            for part in parts:
                if part.startswith("Điểm"):
                    law_point = part
                    break

        # print("req.document_name: ", req.document_name)
        # print('results: ', results)
        results.append(
            {
                "id": data.get("id"),
                "description": data.get("text"),
                "vehicle_category": data.get("category"),
                "fine_min": fine_min,
                "fine_max": fine_max,
                "fine_text": fine_text,
                "law_article": data.get("law_article"),
                "law_clause": data.get("law_clause"),
                "law_point": law_point,
                "extra_penalties": data.get("extra") or [],
                "score": score,
            }
        )

    return {
        "query": req.question,
        "detected_category": target_category,
        "detected_intent": query_intent,
        "document_filter": req.document_name,
        "results": results,
    }


@app.get("/health")
def health():
    return {"status": "ok"}



if __name__ == "__main__":
    import uvicorn
    uvicorn.run("api:app", host="0.0.0.0", port=8000, reload=True)

